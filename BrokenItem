using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class BrokenItem : MonoBehaviour
{
    public float health=100;
    float nowHealth;

    public List<Item> Items = new List<Item>();

    public float barViewTime = 3;
    private float activeTime = 3;
    private bool barIsCreate=false;

    GameObject healthBar;
    GameObject hud;
    Camera cam;
    SceneManager sceneManager;

    private void Start()
    {
        LoadObject();

        //объект загружается до запуска сцены. Так что Find() оптимизацию не испортит.
        sceneManager = GameObject.Find("SceneManager").GetComponent<SceneManager>();
        healthBar = sceneManager.healthBar;
        hud = sceneManager.GetComponent<HudManager>().Hud;
        cam = sceneManager.cam;

    }

    void LoadObject()
    {
        if (PlayerPrefs.GetInt(transform.ToString()+"isCreated")==0)
        {
            PlayerPrefs.SetInt(transform.ToString() + "isCreated", 1);
            PlayerPrefs.SetFloat(transform.ToString(), health);
            nowHealth = health;
        }
        else
        {
            nowHealth = PlayerPrefs.GetFloat(transform.ToString());
            if (nowHealth <= 0)
                Destroy(this.gameObject);
        }
    }


    private void Update()
    {

        if (barIsCreate)
        {
            if (activeTime > 0)
            {
                //настройка расположения хп-бара
                Vector3 pos = cam.WorldToScreenPoint(transform.position + new Vector3(0, 3, 0));
                activeTime -= Time.deltaTime;
                healthBar.GetComponent<RectTransform>().position = pos;
            }
            else if (healthBar.activeSelf)
                healthBar.SetActive(false);
        }

    }


    public void Broke(float val)
    {

        //настройка хп-бара
        Vector3 pos = cam.WorldToScreenPoint(transform.position + new Vector3(0, 3, 0));
        if (!barIsCreate)
        {
            healthBar = Instantiate(healthBar, pos, Quaternion.identity, hud.transform);
            healthBar.GetComponent<Slider>().maxValue = health;
            barIsCreate = true;
        }
        healthBar.GetComponent<RectTransform>().position = pos;
        healthBar.SetActive(true);
        activeTime = barViewTime;
        nowHealth -= val;
        PlayerPrefs.SetFloat(transform.ToString(), nowHealth);
        healthBar.GetComponent<Slider>().value = nowHealth;


        //выпадение дропа и удаление объекта
        if (nowHealth <= 0)
        {
            foreach (Item item in Items)
            {
                int random = Random.Range(1, 101);
                GameObject newObject = sceneManager.Objects[(int)item.Object];
                if (random <= item.chance)
                {
                    random = Random.Range(item.min, item.max + 1);
                    for (int i = 0; i < random; i++)
                    {
                        GameObject drop = Instantiate(newObject, transform.position + new Vector3(Random.Range(-2, 2), 0, Random.Range(-1, 1)), Quaternion.Euler(0, Random.Range(0, 180), 0)) as GameObject;
                        Drop _drop = drop.GetComponent<Drop>();
                        _drop.nameText = sceneManager.language == "RU" ? sceneManager.ObjectsNameRU[(int)item.Object] : sceneManager.ObjectsNameEN[(int)item.Object];
                        _drop.dropText = sceneManager.dropText;
                        _drop.camera = sceneManager.cam;
                    }
                }
            }
            Destroy(healthBar);
            Destroy(this.gameObject);
        }

    }
}

[System.Serializable]
public class Item
{
    public AllObjects.Objects Object;
    [Range(1, 100)]
    public int chance = 50;
    public int min = 1, max = 1;
}
